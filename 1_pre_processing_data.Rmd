---
title: "1_pre_processing_data"
author: "Jennifer Neumaier"
date: "2/24/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Pre-Processing of Data

Importing source files
```{r}
source("./src/0_get_raw_data.R")
```

Importing libraries
```{r}
# Filtering
library(tidyverse)
library(dplyr)
library(metamicrobiomeR)

# Zero-Shot Imputation
library(mbImpute)
library(glmnet)
library(Matrix)
```

Filtering data sets before cleaning, since microbiome data sets are very large! 
Two pre-processed versions will be created:
1. Filtering out all species that account for < 10% abundance in patients.
2. Filtering out all species that account for < 50% abundance in patients.
```{r}
# extract column for every species and count number of samples where this species occurred (> 0)
# Afterwards, divide through length of column and drop all columns that are smaller 10% (or 50%)

EstMB_abundances_10 <- EstMB_abundances
names <- colnames(EstMB_abundances_10)[-1] # [-1] to skip ID columns
res <- replicate(length(names), 0)

for (i in 1:length(res)) {
  vector <- EstMB_abundances_10[names[i]]
  res[i] <- (length(vector[vector > 0])/nrow(vector))*100
  if (res[i] <= 10.0) {
    EstMB_abundances_10[names[i]] <- NULL
  }
}

write.csv(EstMB_abundances_10,"./data/processed/EstMB_abundances_10.csv", row.names = TRUE)


EstMB_abundances_50 <- EstMB_abundances
names <- colnames(EstMB_abundances_50)[-1]
res <- replicate(length(names), 0)

for (i in 1:length(res)) {
  vector <- EstMB_abundances_50[names[i]]
  res[i] <- (length(vector[vector > 0])/nrow(vector))*100
  if (res[i] <= 50.0) {
    EstMB_abundances_50[names[i]] <- NULL
  }
}

write.csv(EstMB_abundances_50,"./data/processed/EstMB_abundances_50.csv", row.names = TRUE)
```


Processing PCOS metadata and cutting out non-sequenced samples
```{r}
# Transposing data frame and renaming
PCOS_abundances <- data.frame(t(PCOS_abundances))

# fit PCOS tables to EstMB design
colnames(PCOS_abundances) <- PCOS_abundances[1,]
PCOS_abundances <- PCOS_abundances[-1,]

PCOS_abundances <- PCOS_abundances %>%
  rownames_to_column(var="SampleID")

# Keeping only phenotype column of metadata
PCOS_metadata <- PCOS_metadata[,1:2]
write.csv(PCOS_metadata,"./data/processed/PCOS_metadata.csv", row.names = TRUE)

# cut patients from PCOS_abundances that are not in metadata
diff <- setdiff(PCOS_abundances$SampleID, PCOS_metadata$SampleID)
PCOS_abundances <- PCOS_abundances[!PCOS_abundances$SampleID %in% diff,]
write.csv(PCOS_metadata,"./data/processed/PCOS_abundances.csv", row.names = TRUE)
```


Filtering data set
Two pre-processed versions will be created:
1. Filtering out all species that account for < 10% abundance in patients.
2. Filtering out all species that account for < 50% abundance in patients.
```{r}
# Filtering
PCOS_abundances_10 <- PCOS_abundances
names <- colnames(PCOS_abundances_10)[-1] # [-1] to skip ID columns
res <- replicate(length(names), 0)

for (i in 1:length(res)) {
  vector <- PCOS_abundances_10[names[i]]
  res[i] <- (length(vector[vector > 0])/nrow(vector))*100
  if (res[i] <= 10.0) {
    PCOS_abundances_10[names[i]] <- NULL
  }
}

write.csv(PCOS_abundances_10,"./data/processed/PCOS_abundances_10.csv", row.names = TRUE)


PCOS_abundances_50 <- PCOS_abundances
names <- colnames(PCOS_abundances_50)[-1]
res <- replicate(length(names), 0)

for (i in 1:length(res)) {
  vector <- PCOS_abundances_50[names[i]]
  res[i] <- (length(vector[vector > 0])/nrow(vector))*100
  if (res[i] <= 50.0) {
    PCOS_abundances_50[names[i]] <- NULL
  }
}

write.csv(PCOS_abundances_50,"./data/processed/PCOS_abundances_50.csv", row.names = TRUE)
```


Filtering-looped work, same results are produced by using sapply
(probably the more sophisticated way)
```{r}
prevelancedf = sapply(X = PCOS_abundances,
                 FUN = function(x){(sum(x > 0)/nrow(PCOS_abundances))*100})

res = prevelancedf[prevelancedf > 50.0]
length(res)

# res for prevelancedf > 10 = 25
# res for prevelancedf > 50 = 1
```


Processing CRC data set and cutting out non-sequenced samples
```{r}
# Transposing data frame and renaming
CRC_abundances <- data.frame(t(CRC_abundances))
colnames(CRC_abundances) <- CRC_abundances[1, ]
CRC_abundances <- CRC_abundances[-1, ]

CRC_abundances <- CRC_abundances %>%
  rownames_to_column(var="SampleID")

write.csv(CRC_abundances,"./data/processed/CRC_abundances.csv", row.names = TRUE)

# Filtering
# ask Oliver for approach

```


