---
title: "1_pre_processing_data"
author: "Jennifer Neumaier"
date: "2/14/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Pre-Processing of Data

Importing source files
```{r}
# source("./src/0_get_raw_data.R")
source("./src/1_get_processed_data.R")
```

Importing libraries
```{r}
# Filtering
library(tidyverse)
library(dplyr)

# Zero-Shot Imputation
library(mbImpute)
library(glmnet)
library(Matrix)
```

Filtering data sets before cleaning, since microbiome data sets are very large! 
Two pre-processed versions will be created:
1. Filtering out all species that account for < 10% abundance in patients.
2. Filtering out all species that account for < 50% abundance in patients.
```{r}
# extract column for every species and count number of samples where this species occurred (> 0)
# Afterwards, divide through length of column and drop all columns that are smaller 10% (or 50%)

EstMB_abundances_10 <- EstMB_abundances
names <- colnames(EstMB_abundances_10)[-1] # [-1] to skip ID columns
res <- replicate(length(names), 0)

for (i in 1:length(res)) {
  vector <- EstMB_abundances_10[names[i]]
  res[i] <- (length(vector[vector > 0])/nrow(vector))*100
  if (res[i] <= 10.0) {
    EstMB_abundances_10[names[i]] <- NULL
  }
}

write.csv(EstMB_abundances_10,"./data/processed/EstMB_abundances_10.csv", row.names = TRUE)


EstMB_abundances_50 <- EstMB_abundances
names <- colnames(EstMB_abundances_50)[-1]
res <- replicate(length(names), 0)

for (i in 1:length(res)) {
  vector <- EstMB_abundances_50[names[i]]
  res[i] <- (length(vector[vector > 0])/nrow(vector))*100
  if (res[i] <= 50.0) {
    EstMB_abundances_50[names[i]] <- NULL
  }
}

write.csv(EstMB_abundances_50,"./data/processed/EstMB_abundances_50.csv", row.names = TRUE)
```


```{r}

```

Processing PCOS metadata and cutting out non-sequenced samples
```{r}
# Transposing data frame and renaming
PCOS_abundances <- data.frame(t(PCOS_abundances))

# fit PCOS tables to EstMB design
colnames(PCOS_abundances) <- PCOS_abundances[1,]
PCOS_abundances <- PCOS_abundances[-1,]

PCOS_abundances <- PCOS_abundances %>%
  rownames_to_column(var="SampleID")

# Keeping only phenotype column of metadata
PCOS_metadata <- PCOS_metadata[,1:2]
write.csv(PCOS_metadata,"./data/processed/PCOS_metadata.csv", row.names = TRUE)

# cut patients from PCOS_abundances that are not in metadata
diff <- setdiff(rownames(PCOS_abundances), PCOS_metadata$SampleID)
PCOS_abundances <- PCOS_abundances[!(rownames(PCOS_abundances) %in% diff),]
```

The same for PCOS data set
(re-do because 25 columns left over in PCO_abundances_10 is too low)
```{r}
# Filtering
PCOS_abundances_10 <- PCOS_abundances
names <- colnames(PCOS_abundances_10)[-1] # [-1] to skip ID columns
res <- replicate(length(names), 0)

for (i in 1:length(res)) {
  vector <- PCOS_abundances_10[names[i]]
  res[i] <- (length(vector[vector > 0])/nrow(vector))*100
  if (res[i] <= 10.0) {
    PCOS_abundances_10[names[i]] <- NULL
  }
}

write.csv(PCOS_abundances_10,"./data/processed/PCOS_abundances_10.csv", row.names = TRUE)


PCOS_abundances_50 <- PCOS_abundances
names <- colnames(PCOS_abundances_50)[-1]
res <- replicate(length(names), 0)

for (i in 1:length(res)) {
  vector <- PCOS_abundances_50[names[i]]
  res[i] <- (length(vector[vector > 0])/nrow(vector))*100
  if (res[i] <= 50.0) {
    PCOS_abundances_50[names[i]] <- NULL
  }
}

write.csv(PCOS_abundances_50,"./data/processed/PCOS_abundances_50.csv", row.names = TRUE)

```



The same for CRC data set
```{r}
# Transposing data frame and renaming
CRC_abundances <- data.frame(t(CRC_abundances))
colnames(CRC_abundances) <- CRC_abundances[1, ]
CRC_abundances <- CRC_abundances[-1, ]

# Filtering
# needs different approach as these are not relative counts

```


